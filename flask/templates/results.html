<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VERIFLITE – Results</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    {% if rows|length > 1 %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
    {% endif %}
</head>
<body>
    <div class="image-container">
        <a href="https://www.veriflite.com" target="_blank">
            <img src="{{ url_for('static', filename='veriflite.png') }}" alt="Veriflite Logo" class="responsive-image" style="width: 50%;">
        </a>
    </div>

    <div style="margin-bottom: 1em;">
        <a href="{{ url_for('index') }}" class="back-btn">← Back to search</a>
    </div>

    <h2>Search: {{ search_terms }}</h2>
    <p>{{ rows|length }} result{{ 's' if rows|length != 1 }}</p>

    {% if rows %}

    {% if rows|length > 1 and scatter_data %}
    <div class="chart-container">
        <canvas id="scatter-chart"></canvas>
    </div>
    <script>
    (function() {
        const data = {{ scatter_data | tojson }};
        new Chart(document.getElementById('scatter-chart'), {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'D vs Total',
                    data: data.map(d => ({ x: d.x, y: d.y })),
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    pointRadius: 5,
                    pointHoverRadius: 7,
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Difficulty vs Total Score' },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) {
                                const d = data[ctx.dataIndex];
                                return `${d.label} — D:${d.x.toFixed(1)} E:${d.execution.toFixed(2)} Total:${d.y.toFixed(3)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Difficulty (D)' } },
                    y: { title: { display: true, text: 'Total Score' } }
                }
            }
        });
    })();
    </script>
    {% endif %}

    {% set max_deductions = {'tra': 10, 'dmt': 2, 'tum': 8}.get(discipline, 0) %}

    <div style="margin-bottom: 0.5em;">
        <button id="export-csv" type="button" style="background-color:#6c757d;">Export CSV</button>
    </div>

    <div class="table-scroll">
    <table class="results-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Stage</th>
                <th>Athlete</th>
                <th>Rep.</th>
                <th>Level</th>
                <th>Event</th>
                <th>Country</th>
                <th>D</th>
                {% if discipline == 'tra' %}
                <th>ToF</th>
                <th>DT</th>
                <th>H</th>
                {% endif %}
                <th>E</th>
                {% for i in range(max_deductions) %}<th class="deduction-cell"></th>{% endfor %}
                <th>L</th>
                <th>P</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            {% for r in rows %}
            <tr>
                <td>{{ r.date }}</td>
                <td>{{ r.stage }}</td>
                <td><a href="{{ url_for('athlete', given_name=r.given_name, surname=r.surname) }}">{{ r.given_name }} {{ r.surname }}</a></td>
                <td>{{ r.representing }}</td>
                <td>{{ r.level }}</td>
                <td>{{ r.event }}</td>
                <td>{{ r.country }}</td>
                <td class="{{ 'best-score' if r.is_best_dd else '' }}">{{ '%.1f'|format(r.dd) }}</td>
                {% if discipline == 'tra' %}
                <td class="{{ 'best-score' if r.is_best_tof else '' }}">{{ '%.2f'|format(r.tof) }}</td>
                <td class="{{ 'best-score' if r.is_best_dt else '' }}">{{ '%.2f'|format(r.dt) }}</td>
                <td class="{{ 'best-score' if r.is_best_hd else '' }}">{{ '%.1f'|format(r.hd) }}</td>
                {% endif %}
                <td class="{{ 'best-score' if r.is_best_exec else '' }}">{{ '%.2f'|format(r.execution) }}</td>
                {% for i in range(max_deductions) %}
                  {% if i < r.deductions|length %}
                    <td class="deduction-cell" style="background-color: {{ r.deduction_colors[i] }}">{{ r.deductions[i] }}</td>
                  {% else %}
                    <td class="deduction-cell"></td>
                  {% endif %}
                {% endfor %}
                <td class="{{ 'nonzero' if r.landing else '' }}">{{ r.landing }}</td>
                <td class="{{ 'nonzero' if r.penalty else '' }}">{{ r.penalty }}</td>
                <td class="{{ 'best-score' if r.is_best_total else '' }}">{{ '%.3f'|format(r.total) }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="best-row">
                <td colspan="7">BEST</td>
                <td class="best-score">{{ '%.1f'|format(bests.dd) }}</td>
                {% if discipline == 'tra' %}
                <td class="best-score">{{ '%.2f'|format(bests.tof) }}</td>
                <td class="best-score">{{ '%.2f'|format(bests.dt) }}</td>
                <td class="best-score">{{ '%.1f'|format(bests.hd) }}</td>
                {% endif %}
                <td class="best-score">{{ '%.2f'|format(bests.exec) }}</td>
                {% for i in range(max_deductions) %}<td></td>{% endfor %}
                <td></td>
                <td></td>
                <td class="best-score">{{ '%.3f'|format(bests.total) }}</td>
            </tr>
        </tfoot>
    </table>
    </div>
    {% else %}
    <p>No results found.</p>
    {% endif %}

<div id="loading" style="display:none;">
  <div class="spinner"></div>
  <p>Loading athlete…</p>
</div>

<script>
  document.querySelectorAll('.results-table a').forEach(function(link) {
    link.addEventListener('click', function() {
      document.getElementById('loading').style.display = 'flex';
    });
  });

  var exportBtn = document.getElementById('export-csv');
  if (exportBtn) {
    exportBtn.addEventListener('click', function() {
      var table = document.querySelector('.results-table');
      var headerCells = Array.from(table.querySelectorAll('thead th'));
      var keepCols = [];
      var headerNames = [];
      headerCells.forEach(function(th, i) {
        if (!th.classList.contains('deduction-cell')) {
          keepCols.push(i);
          headerNames.push(th.textContent.trim() || ('Col' + i));
        }
      });
      var csvRows = [headerNames.map(function(h) { return '"' + h + '"'; }).join(',')];
      table.querySelectorAll('tbody tr').forEach(function(tr) {
        var cells = Array.from(tr.querySelectorAll('td'));
        var vals = keepCols.map(function(i) {
          var cell = cells[i];
          var text = cell ? cell.textContent.trim() : '';
          return '"' + text.replace(/"/g, '""') + '"';
        });
        csvRows.push(vals.join(','));
      });
      var csv = csvRows.join('\n');
      var blob = new Blob([csv], { type: 'text/csv' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'results.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });
  }
</script>
<script src="{{ url_for('static', filename='sort-table.js') }}"></script>

</body>
</html>
